name: Dedupe weekly (from Drive)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "47 12 * * 5" # every friday at 12:47 UTC 

jobs:
  dedupe-weekly-from-drive:
    runs-on: ubuntu-latest

    env:
      WEEKLY_INPUT_GOOGLE_DIR: weekly_input/google
      WEEKLY_INPUT_RSS_DIR: weekly_input/rss
      GOOGLE_APPLICATION_CREDENTIALS: service_account.json
      GDRIVE_GOOGLE_FOLDER_ID: ${{ secrets.GDRIVE_GOOGLE_FOLDER_ID }}
      GDRIVE_RSS_FOLDER_ID: ${{ secrets.GDRIVE_RSS_FOLDER_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements/upload_digests.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/upload_digests.txt

      - name: Write service account JSON
        run: |
          printf '%s' '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}' > "$GOOGLE_APPLICATION_CREDENTIALS"
          ls -l "$GOOGLE_APPLICATION_CREDENTIALS"

      # ---------- GOOGLE ----------

      - name: Fetch weekly Google CSVs from Drive (Sat–Fri)
        run: |
          mkdir -p "$WEEKLY_INPUT_GOOGLE_DIR"
          python fetch_week_from_drive.py \
            "$WEEKLY_INPUT_GOOGLE_DIR" \
            google_alerts_articles \
            GDRIVE_GOOGLE_FOLDER_ID

      - name: List downloaded Google CSVs (debug)
        run: |
          echo "Contents of $WEEKLY_INPUT_GOOGLE_DIR:"
          find "$WEEKLY_INPUT_GOOGLE_DIR" -maxdepth 3 -type f -print

      - name: Run weekly Google dedupe
        run: |
          python dedupe_google_weekly.py "$WEEKLY_INPUT_GOOGLE_DIR"

      - name: Upload weekly Google digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: google_weekly_digest
          path: data/digests/weekly/google_weekly_*.csv

      # ---------- RSS ----------

      - name: Fetch weekly RSS CSVs from Drive (Sat–Fri)
        run: |
          mkdir -p "$WEEKLY_INPUT_RSS_DIR"
          python fetch_week_from_drive.py \
            "$WEEKLY_INPUT_RSS_DIR" \
            rss_articles \
            GDRIVE_RSS_FOLDER_ID

      - name: List downloaded RSS CSVs (debug)
        run: |
          echo "Contents of $WEEKLY_INPUT_RSS_DIR:"
          find "$WEEKLY_INPUT_RSS_DIR" -maxdepth 3 -type f -print

      - name: Run weekly RSS dedupe
        run: |
          python dedupe_rss_weekly.py "$WEEKLY_INPUT_RSS_DIR"

      - name: Upload weekly RSS digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: rss_weekly_digest
          path: data/digests/weekly/rss_weekly_*.csv

  upload-weekly-digests:
    runs-on: ubuntu-latest
    needs: dedupe-weekly-from-drive
    env:
      GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Google weekly digest artifact
        uses: actions/download-artifact@v4
        with:
          name: google_weekly_digest
          path: artifacts/google

      - name: Download RSS weekly digest artifact
        uses: actions/download-artifact@v4
        with:
          name: rss_weekly_digest
          path: artifacts/rss

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements/upload_digests.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/upload_digests.txt

      - name: Upload Google weekly digest to Drive
        env:
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_GOOGLE_FOLDER_ID }}
        run: |
          files=$(find artifacts/google -type f -name "google_weekly_*.csv" || true)

          if [ -z "$files" ]; then
            echo "No Google weekly digest CSV files found; nothing to upload."
            exit 0
          fi

          echo "Found Google weekly digest files:"
          echo "$files"

          python upload_digests_to_gdrive.py $files

      - name: Upload RSS weekly digest to Drive
        env:
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_RSS_FOLDER_ID }}
        run: |
          files=$(find artifacts/rss -type f -name "rss_weekly_*.csv" || true)

          if [ -z "$files" ]; then
            echo "No RSS weekly digest CSV files found; nothing to upload."
            exit 0
          fi

          echo "Found RSS weekly digest files:"
          echo "$files"

          python upload_digests_to_gdrive.py $files
