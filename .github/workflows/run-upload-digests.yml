name: Collect digests and upload to Google Drive

on:
  workflow_dispatch: {}
  schedule:
    - cron: "27 12 * * *" # every day at 12:27 UTC to accommodate rss scraper + jitter and round number github delays  

permissions:
  contents: read
  actions: read 

jobs:
  upload-google-digests:
    runs-on: ubuntu-latest
    env:
      GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_GOOGLE_FOLDER_ID }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download latest Google Alerts artifact
        uses: dawidd6/action-download-artifact@v11
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: run-news-google.yml
          # Only consider successful runs:
          workflow_conclusion: success
          path: artifacts/google

      - name: Show downloaded Google files (debug)
        run: |
          echo "Downloaded Google artifacts:"
          ls -R artifacts/google || echo "No artifacts downloaded."

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements/upload_digests.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/upload_digests.txt

      - name: Upload Google digests to Google Drive
        run: |
          # Find only digest CSVs, not error logs
          files=$(find artifacts/google -type f -path "*/digests/google_digests/*.csv" || true)

          if [ -z "$files" ]; then
            echo "No Google digest CSV files found; nothing to upload."
            exit 0
          fi

          echo "Found Google digest files:"
          echo "$files"

          python upload_digests_to_gdrive.py $files

  upload-rss-digests:
    runs-on: ubuntu-latest
    env:
      GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_RSS_FOLDER_ID }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download latest RSS scraper artifact
        uses: dawidd6/action-download-artifact@v11
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: run-news-rss.yml
          workflow_conclusion: success
          path: artifacts/rss

      - name: Show downloaded RSS files (debug)
        run: |
          echo "Downloaded RSS artifacts:"
          ls -R artifacts/rss || echo "No artifacts downloaded."

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements/upload_digests.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/upload_digests.txt

      - name: Upload RSS digests to Google Drive
        run: |
          # Find only digest CSVs, not error logs
          files=$(find artifacts/rss -type f -path "*/digests/rss_digests/*.csv" || true)

          if [ -z "$files" ]; then
            echo "No RSS digest CSV files found; nothing to upload."
            exit 0
          fi

          echo "Found RSS digest files:"
          echo "$files"

          python upload_digests_to_gdrive.py $files
